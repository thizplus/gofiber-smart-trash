{
	"info": {
		"_postman_id": "smart-trash-picker-2025",
		"name": "Smart Trash Picker API",
		"description": "API Collection for Smart Trash Picker - IoT trash collection system with ESP32-CAM\n\n## Endpoints\n- Health Check\n- Generate Upload URL (Presigned URL for R2)\n- Create Trash Record\n- List Trash Records\n- Get Trash Record by ID\n\n## Flow\n1. ESP32 calls `/api/upload-url?device_id=XXX` to get presigned URL\n2. ESP32 uploads image directly to R2 using presigned URL\n3. ESP32 calls `/api/trash` to save record with GPS coordinates\n4. View records via `/api/trash` or `/api/trash/:id`",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Health & Info",
			"item": [
				{
					"name": "Root - API Info",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/",
							"host": [
								"{{base_url}}"
							],
							"path": [
								""
							]
						},
						"description": "Get API information and version"
					},
					"response": []
				},
				{
					"name": "Health Check",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/health",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"health"
							]
						},
						"description": "Check if API is healthy and running"
					},
					"response": []
				}
			],
			"description": "Basic health check and info endpoints"
		},
		{
			"name": "Upload",
			"item": [
				{
					"name": "Generate Upload URL",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Save response data for next requests",
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    if (response.success && response.data) {",
									"        pm.environment.set('upload_url', response.data.upload_url);",
									"        pm.environment.set('image_url', response.data.image_url);",
									"        pm.environment.set('expires_in', response.data.expires_in);",
									"        console.log('✓ Upload URL:', response.data.upload_url);",
									"        console.log('✓ Image URL:', response.data.image_url);",
									"        console.log('✓ Expires in:', response.data.expires_in, 'seconds');",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/upload-url?device_id={{device_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"upload-url"
							],
							"query": [
								{
									"key": "device_id",
									"value": "{{device_id}}",
									"description": "Device ID (MAC address or unique identifier)"
								}
							]
						},
						"description": "Generate a presigned URL for uploading trash images to Cloudflare R2.\n\n**Query Parameters:**\n- `device_id` (required): Device identifier (e.g., ESP32 MAC address)\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"upload_url\": \"https://account.r2.cloudflarestorage.com/bucket/trash/DEVICE/timestamp.jpg?signature=...\",\n    \"image_url\": \"https://pub-xxx.r2.dev/trash/DEVICE/timestamp.jpg\",\n    \"expires_in\": 900\n  }\n}\n```\n\n**Next Step:**\nUse `upload_url` to upload image with PUT request (see \"Upload Image to R2\" request)"
					},
					"response": []
				},
				{
					"name": "Upload Image to R2",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Check if upload_url exists",
									"const uploadUrl = pm.environment.get('upload_url');",
									"if (!uploadUrl) {",
									"    console.error('❌ No upload_url found! Please run \"Generate Upload URL\" first.');",
									"    throw new Error('upload_url not set. Run \"Generate Upload URL\" first.');",
									"}",
									"console.log('✓ Using upload URL from environment');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "image/jpeg",
								"type": "text"
							}
						],
						"body": {
							"mode": "file",
							"file": {
								"src": ""
							}
						},
						"url": {
							"raw": "{{upload_url}}",
							"host": [
								"{{upload_url}}"
							]
						},
						"description": "Upload an image file directly to Cloudflare R2 using the presigned URL.\n\n**Prerequisites:**\n1. Run \"Generate Upload URL\" first to get the presigned URL\n2. Select an image file in the Body tab\n\n**Headers:**\n- `Content-Type: image/jpeg`\n\n**Body:**\n- Select \"binary\" and choose an image file (JPEG recommended)\n\n**Note:**\n- This is a direct upload to R2, not to our API\n- The presigned URL expires in 15 minutes (900 seconds)\n- After successful upload, use the `image_url` in the next step"
					},
					"response": []
				}
			],
			"description": "Upload image workflow:\n1. Get presigned URL from API\n2. Upload image directly to R2 using presigned URL"
		},
		{
			"name": "Trash Records",
			"item": [
				{
					"name": "Create Trash Record",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Save trash ID for later use",
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    if (response.success && response.data) {",
									"        pm.environment.set('trash_id', response.data.id);",
									"        console.log('✓ Trash record created with ID:', response.data.id);",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// Use image_url from previous step if available",
									"const imageUrl = pm.environment.get('image_url');",
									"if (imageUrl) {",
									"    console.log('✓ Using image URL from environment:', imageUrl);",
									"} else {",
									"    console.warn('⚠ No image_url in environment. Using example URL.');",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"device_id\": \"{{device_id}}\",\n  \"image_url\": \"{{image_url}}\",\n  \"latitude\": 13.756331,\n  \"longitude\": 100.501762\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/trash",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"trash"
							]
						},
						"description": "Create a new trash record after uploading the image.\n\n**Prerequisites:**\n1. Run \"Generate Upload URL\"\n2. Run \"Upload Image to R2\"\n3. Then create the record\n\n**Request Body:**\n```json\n{\n  \"device_id\": \"AABBCC112233\",\n  \"image_url\": \"https://pub-xxx.r2.dev/trash/DEVICE/timestamp.jpg\",\n  \"latitude\": 13.756331,\n  \"longitude\": 100.501762\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": 1,\n    \"device_id\": \"AABBCC112233\",\n    \"image_url\": \"https://pub-xxx.r2.dev/trash/DEVICE/timestamp.jpg\",\n    \"latitude\": 13.756331,\n    \"longitude\": 100.501762,\n    \"created_at\": \"2025-12-04T05:59:14Z\"\n  }\n}\n```"
					},
					"response": []
				},
				{
					"name": "List All Trash Records",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/trash?limit={{limit}}&offset={{offset}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"trash"
							],
							"query": [
								{
									"key": "device_id",
									"value": "{{device_id}}",
									"description": "Filter by device ID",
									"disabled": true
								},
								{
									"key": "limit",
									"value": "{{limit}}",
									"description": "Number of records per page (max 100)"
								},
								{
									"key": "offset",
									"value": "{{offset}}",
									"description": "Offset for pagination"
								}
							]
						},
						"description": "List all trash records with optional filtering and pagination.\n\n**Query Parameters:**\n- `device_id` (optional): Filter by specific device\n- `limit` (optional): Records per page (default: 20, max: 100)\n- `offset` (optional): Offset for pagination (default: 0)\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"data\": [\n      {\n        \"id\": 1,\n        \"device_id\": \"AABBCC112233\",\n        \"image_url\": \"https://pub-xxx.r2.dev/trash/...\",\n        \"latitude\": 13.756331,\n        \"longitude\": 100.501762,\n        \"created_at\": \"2025-12-04T05:59:14Z\"\n      }\n    ],\n    \"pagination\": {\n      \"total\": 156,\n      \"limit\": 20,\n      \"offset\": 0\n    }\n  }\n}\n```"
					},
					"response": []
				},
				{
					"name": "List Trash by Device ID",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/trash?device_id={{device_id}}&limit=20&offset=0",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"trash"
							],
							"query": [
								{
									"key": "device_id",
									"value": "{{device_id}}",
									"description": "Filter by device ID"
								},
								{
									"key": "limit",
									"value": "20",
									"description": "Records per page"
								},
								{
									"key": "offset",
									"value": "0",
									"description": "Offset for pagination"
								}
							]
						},
						"description": "List trash records from a specific device.\n\nFilters records by `device_id` parameter."
					},
					"response": []
				},
				{
					"name": "Get Trash Record by ID",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/trash/{{trash_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"trash",
								"{{trash_id}}"
							]
						},
						"description": "Get a single trash record by its ID.\n\n**Path Parameters:**\n- `id`: Trash record ID\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": 123,\n    \"device_id\": \"AABBCC112233\",\n    \"image_url\": \"https://pub-xxx.r2.dev/trash/DEVICE/timestamp.jpg\",\n    \"latitude\": 13.756331,\n    \"longitude\": 100.501762,\n    \"created_at\": \"2025-12-04T05:59:14Z\"\n  }\n}\n```"
					},
					"response": []
				}
			],
			"description": "CRUD operations for trash records"
		},
		{
			"name": "ESP32 Complete Flow",
			"item": [
				{
					"name": "1. Generate Upload URL",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Save for next steps",
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('upload_url', response.data.upload_url);",
									"    pm.environment.set('image_url', response.data.image_url);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/upload-url?device_id={{device_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"upload-url"
							],
							"query": [
								{
									"key": "device_id",
									"value": "{{device_id}}"
								}
							]
						},
						"description": "**Step 1:** ESP32 requests presigned URL"
					},
					"response": []
				},
				{
					"name": "2. Upload Image to R2 (Manual)",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "image/jpeg",
								"type": "text"
							}
						],
						"body": {
							"mode": "file",
							"file": {
								"src": ""
							}
						},
						"url": {
							"raw": "{{upload_url}}",
							"host": [
								"{{upload_url}}"
							]
						},
						"description": "**Step 2:** ESP32 uploads image to R2\n\n**Manual Step:** Select image file in Body tab"
					},
					"response": []
				},
				{
					"name": "3. Create Trash Record",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const response = pm.response.json();",
									"    pm.environment.set('trash_id', response.data.id);",
									"    console.log('✓ Complete! Trash ID:', response.data.id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"device_id\": \"{{device_id}}\",\n  \"image_url\": \"{{image_url}}\",\n  \"latitude\": 13.756331,\n  \"longitude\": 100.501762\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/trash",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"trash"
							]
						},
						"description": "**Step 3:** ESP32 saves record to database"
					},
					"response": []
				}
			],
			"description": "Complete ESP32 workflow in sequence:\n1. Get presigned URL\n2. Upload image to R2\n3. Create trash record\n\nRun these requests in order to simulate the full ESP32 flow."
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:3000",
			"type": "string"
		},
		{
			"key": "device_id",
			"value": "AABBCC112233",
			"type": "string"
		},
		{
			"key": "limit",
			"value": "20",
			"type": "string"
		},
		{
			"key": "offset",
			"value": "0",
			"type": "string"
		},
		{
			"key": "upload_url",
			"value": "",
			"type": "string"
		},
		{
			"key": "image_url",
			"value": "",
			"type": "string"
		},
		{
			"key": "trash_id",
			"value": "1",
			"type": "string"
		}
	]
}
